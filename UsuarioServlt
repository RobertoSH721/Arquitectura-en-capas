package com.gosama.presentacion;

import com.gosama.negocio.UsuarioService;
import com.gosama.entidades.Usuario;
import java.io.IOException;
import java.util.List;
import javax.ejb.EJB;
import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.mindrot.jbcrypt.BCrypt;

@WebServlet("/register")
public class RegisterUserServlet extends HttpServlet {
    
    private UserService userService;

    @Override
    public void init() throws ServletException {
        // Inicializa el servicio de usuarios
        this.userService = new UserService();
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // Método GET para mostrar el formulario de registro
        // Puedes redirigir a la página de registro (formulario)
        request.getRequestDispatcher("/register.jsp").forward(request, response);
    }

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    // Método POST para procesar los datos del formulario de registro
    String nombre = request.getParameter("nombre");
    String apellidos = request.getParameter("apellidos");
    String telefono = request.getParameter("telefono");
    String email = request.getParameter("email");
    String password = request.getParameter("password");

    // Encriptar la contraseña antes de crear el usuario
    String hashedPassword = BCrypt.hashpw(password, BCrypt.gensalt());

    // Crear un objeto usuario y configurarlo
    Usuario usuario = new Usuario();
    usuario.setNombre(nombre);
    usuario.setApellidos(apellidos);
    usuario.setTelefono(telefono);
    usuario.setCorreo(email);
    usuario.setPassword(hashedPassword);  // Usar la contraseña encriptada aquí

    // Registrar el usuario
    boolean isRegistered = usuarioService.registrarUsuario(usuario);

    if (isRegistered) {
        response.sendRedirect("index.jsp");  // Redirigir a la página principal después del registro
    } else {
        response.sendRedirect("registro.jsp?error=1");  // Redirigir al formulario con un error
    }
  }
}


